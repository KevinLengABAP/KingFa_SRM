sap.ui.define(["ZEC_MY_REQUIREMENTS/controller/BaseController","sap/ui/model/json/JSONModel","sap/m/MessageToast","sap/ui/core/routing/History","sap/ui/core/mvc/Controller","ZEC_MY_REQUIREMENTS/utils/Validator","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/m/ColumnListItem"],function(e,t,r,a,s,i,n,o,l){"use strict";var u=new t([]);var g=[];var h=new t;return e.extend("ZEC_MY_REQUIREMENTS.controller.RequirementsPo",{onInit:function(){this.getRouter().getRoute("requirementsPo").attachPatternMatched(this._onRequestMatched,this);var e=this.getOwnerComponent().getEventBus();e.subscribe("applyChange",this.applyChange,this);this.getView().setModel(h,"RequireHead");this.getView().setModel(u,"PrList")},_onRequestMatched:function(e){var t=e.getParameters().arguments.ObjectId;var r=this;var a=this.getView().byId("Bsart");var s=this.getGlobalVar("CurObjId");if(!s||s!==t){this.setGlobalVar("CurObjId",t);this.getModel().read("/CartSet('"+t+"')",{async:false,success:function(e,t){h.setData(e);r.setGlobalVar("Stat",e.Stat);r.getGlobalVar("Bsart",e.Bsart);var s=r.getGlobalVar("Bsart");if(s){a.setSelectedKey(s);a.setEditable(false)}if(e.Stat!=="10"&&e.Stat!=="20"){r.setGlobalVar("isEdit",false)}else{r.setGlobalVar("isEdit",true)}},error:function(e){}});var i=[];var l=[];var d=true;i.push(new n("ObjectId",o.EQ,t));this.getModel().read("/CartItemSet",{filters:i,success:function(e,t){if(e.results){var a={};var s;for(var i in e.results){if(e.results[i].Ebeln!==undefined&&e.results[i].Ebeln!==""){d=false}a=e.results[i];if(a.Knttp==="A"){a.Asset=a.KnValue}else if(a.Knttp==="K"){a.Kostl=a.KnValue}l.push(a)}}u.setData(l);r.getView().byId("text").setText("总共"+l.length+"个项目");r.calculateTotal(l);r.getModel("PrList").refresh();sap.ui.getCore().cartmodel=u;if(r.getGlobalVar("Stat")==="25"&&d===true){r.byId("delbtn").setEnabled(true)}},error:function(e){}})}else{var c=u.getData();this.byId("PrTable").removeSelections();g=[];this.getModel().refresh();this.getView().byId("text").setText("总共"+c.length+"个项目");this.calculateTotal(c)}this.byId("PrTable").removeSelections()},onEditPress:function(e){var t=e.getSource().getBindingContext("PrList");var r=t.getObject();var a=t.getPath();g=[];g.push(this.convPathToOrder(a));sap.ui.getCore().edititem=r;this.getOwnerComponent().getRouter().navTo("requireEditPo",{guid:r.GuidI})},calculateTotal:function(e){var t=0,r;if(e.length>0){for(var a=0;a<e.length;a++){t=t+parseFloat(e[a].Value);r=e[a].Waers}this.getView().byId("sum").setText(parseFloat(t).toFixed(2)+r)}else{this.getView().byId("sum").setText(parseFloat(t).toFixed(2))}},onDelete:function(e){var t=this;var a=this.getView().byId("ObjectId").getText();this.getModel().callFunction("/DeleteCartData",{method:"POST",urlParameters:{ObjectId:a},success:function(e,a){r.show("删除成功");t.getModel().refresh();t.onNavBack()},error:function(e){r.show("删除失败")}})},onGoPO:function(e){var t=this.getView().byId("ObjectId").getText();if(t){this.getOwnerComponent().getRouter().navTo("PoDetial",{ObjectId:t})}},onMultipleDelete:function(e){var t=this;var a=this.getView().byId("ObjectId").getText();var s=[],i,n,o=[],l=[];var g=this.byId("PrTable").getSelectedItems();if(g.length===0){r.show("请至少选择一行进行删除");return}for(var h=0;h<g.length;h++){i=g[h].getBindingContext("PrList").getPath();l.push(this.convPathToOrder(i))}for(var d=0;d<g.length;d++){n=g[d].getBindingContext("PrList").getObject().Posnr;o.push(n)}o.sort();if(a!==undefined&&a!==""){this.getModel().callFunction("/DeleteCartItemData",{method:"POST",urlParameters:{ObjectId:a,Posnr:o},success:function(e,a){var i=t.getView().getModel("PrList").getData();if(l.length===i.length){i.splice(0,i.length);s.push(i)}else{for(var n=l.length-1;n>=0;n--){s.push(i[l[n]]);i.splice(l[n],1)}}u.setData(i);t.getModel().refresh();r.show("行项目删除成功")},error:function(e){r.show("行项目删除失败")}})}else{var c=this.getView().getModel("PrList").getData();if(l.length===c.length){c.splice(0,c.length)}else{for(var f=l.length-1;f>=0;f--){c.splice(l[f],1)}}u.setData(c);t.getModel().refresh();r.show("行项目删除成功")}},applyChange:function(e,t,r){var a=u.getData();var s;for(var i=0;i<g.length;i++){s=g[i];for(var n in r){a[s][n]=r[n]}if(r.Menge){a[s].Value=a[s].Menge*a[s].Netpr/a[s].Peinh}}u.setData(a);this.calculateTotal(a);this.byId("PrTable").removeSelections();g=[]},onBatchUpdate:function(e){var t=this.byId("PrTable").getSelectedItems();if(t.length===0){r.show("请至少选择一行进行批量修改");return}else{var a;for(var s=0;s<t.length;s++){a=t[s].getBindingContext("PrList").getPath();g.push(this.convPathToOrder(a))}this.getOwnerComponent().getRouter().navTo("batchEdit",{})}},onSave:function(e){this.onSaveandsubmit(false)},onSubmit:function(e){this.onSaveandsubmit(true)},onSaveandsubmit:function(e){var t=new i;var a=this.byId("CheckLayout");if(t.validate(a)){var s=this.getView().getModel("RequireHead").getData();var n=[];var o=this.getView().getModel("PrList").getData();var l=new Date;if(o&&o.length>0){var g;var h;var d;for(var c=0;c<o.length;c++){if(!o[c].Werks){r.show("行号"+o[c].Posnr+"输入必输项,工厂必输");return}if(!d){d=o[c].Werks}else if(d!==o[c].Werks){r.show("行号"+o[c].Posnr+"工厂不一致");return}if(o[c].Menge.length>10){r.show("行号"+o[c].Posnr+"数量长度不得超过10位");return}if(!o[c].DelivDate){r.show("行号"+o[c].Posnr+"维护交货日期");return}if(this.compareDate(l,o[c].DelivDate)){r.show("行号"+o[c].Posnr+"交货日期不能是在过去");return}if(!o[c].Knttp){r.show("行号"+o[c].Posnr+"维护账户分配");return}if(!g){g=o[c].Knttp}else if(g!==o[c].Knttp){r.show("需求明细账户分配(库存/成本中心)不一致!");return}if(g==="A"){h=o[c].Asset}else if(g==="K"){if(!o[c].Kostl||!o[c].Hkont){r.show("请先输入必输项,成本中心和科目必输");return}h=o[c].Kostl}var f={Posnr:o[c].Posnr.toString(),ProductId:o[c].ProductId,Description:o[c].Description,Menge:o[c].Menge.toString(),Meins:o[c].Meins,Netpr:o[c].Netpr,Lifnr:o[c].Lifnr,LifnrNam:o[c].LifnrNam,GuidH:o[c].GuidH?o[c].GuidH.toUpperCase().replaceAll("-",""):"",GuidI:o[c].GuidI?o[c].GuidI.toUpperCase().replaceAll("-",""):"",CatalogGuid:o[c].CatalogGuid?o[c].CatalogGuid.toUpperCase().replaceAll("-",""):"",Value:o[c].Value.toString(),Waers:o[c].Waers,CategoryId:o[c].CategoryId,CategoryTxt:o[c].CategoryTxt,Matkl:o[c].Matkl,Hkont:o[c].Hkont,DelivDate:o[c].DelivDate,Ekgrp:o[c].Ekgrp,Werks:o[c].Werks,Note:o[c].Note,Knttp:o[c].Knttp,Lgort:o[c].Lgort,KnValue:h,Mwskz:o[c].Mwskz,Peinh:o[c].Peinh.toString(),Ekorg:s.Ekorg,Bukrs:s.Bukrs};n.push(f)}}if(!n||n.length===0){r.show("保存行项目数据不能为空!");return}var v={ObjectId:s.ObjectId,Description:s.Description,Ernam:s.Ernam,Bukrs:s.Bukrs,Ekorg:s.Ekorg,Remark:s.Remark,Stat:"10",GrAddr:s.GrAddr,GrTel:s.GrTel,Bsart:s.Bsart,CartItemSet:n};var b=this;if(!s.ObjectId){var p="创建成功"}else{p="更新成功"}this.setGlobalVar("busy",true);this.getModel().create("/CartSet",v,{async:false,success:function(t,a){b.getView().byId("ObjectId").setText(t.ObjectId);b.getView().byId("Ernam").setText(t.Ernam);var s={};var i=[];for(c=0;c<t.CartItemSet.results.length;c++){s=t.CartItemSet.results[c];if(s.Knttp==="A"){s.Asset=s.KnValue}else if(s.Knttp==="K"){s.Kostl=s.KnValue}i.push(s)}u.setData(i);r.show("PR号"+t.ObjectId+p);if(e){var n=b.getView().byId("ObjectId").getText();if(n){b.getModel().callFunction("/SubmitCartData",{method:"POST",urlParameters:{ObjectId:n},success:function(e,t){r.show("提交OA成功");b.getModel().refresh();b.setGlobalVar("busy",false);b.onNavBack()},error:function(e){b.setGlobalVar("busy",false);var t=JSON.parse(e.responseText);var a=t.error.message.value;r.show("提交失败,消息:"&&a)}})}}else{b.setGlobalVar("busy",false)}}.bind(this),error:function(e){b.setGlobalVar("busy",false);var t=JSON.parse(e.responseText);var a=t.error.message.value;r.show("PR号创建失败,消息:"&&a)}})}},onExit:function(){var e=this.getOwnerComponent().getEventBus();e.unsubscribe("applyChange")}})});
//# sourceMappingURL=RequirementsPo.controller.js.map
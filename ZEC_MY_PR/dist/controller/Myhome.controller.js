sap.ui.define(["ZEC_MY_REQUIREMENTS/controller/BaseController","sap/ui/model/json/JSONModel","sap/m/GroupHeaderListItem","sap/ui/core/Priority","sap/m/MessageToast","sap/ui/core/routing/History","sap/ui/core/mvc/Controller","ZEC_MY_REQUIREMENTS/utils/Validator"],function(e,t,r,i,a,o,s,n){"use strict";var u=new t([]);var g=[];var d=[];var l=new t([]);return e.extend("ZEC_MY_REQUIREMENTS.controller.Myhome",{onInit:function(){this.getOwnerComponent().getRouter().getRoute("Myhome").attachPatternMatched(this._onRequestMatched,this)},_onRequestMatched:function(e){debugger;var r=this.getView().getModel("requirementsPo");var i=e.getParameters()["arguments"].ObjectId;l={ObjectId:i};var a=new t(l);this.getView().setModel(a,"RequireHead")},onEditPress:function(e){var t=e.getSource().getParent().getBindingContext("PrList").getObject();g.push(t);this.onItemDisData(g,t);if(t.ProductId.length<=0){this.getOwnerComponent().getRouter().navTo("requireEdit",{ProductId:t.Maktx})}else{this.getOwnerComponent().getRouter().navTo("requireEdit",{ProductId:t.ProductId})}},onItemDisData:function(e,t){if(sap.ui.getCore().requireDetailEdit){for(var r=0;r<sap.ui.getCore().requireDetailEdit.length;r++){if(t.Posnr===sap.ui.getCore().requireDetailEdit[r].Posnr){for(var i=0;i<e.length;i++){for(var a=i+1;a<e.length;a++){if(e[i].Posnr===e[a].Posnr){e.splice(r,1)}}}e.forEach(function(t,i,a){if(t.Posnr===sap.ui.getCore().requireDetailEdit[r].Posnr){e[i]["DelivDate"]=sap.ui.getCore().requireDetailEdit[r].DelivDate;e[i]["Ekorg"]=sap.ui.getCore().requireDetailEdit[r].Ekorg;e[i]["Matkl"]=sap.ui.getCore().requireDetailEdit[r].Matkl;e[i]["Note"]=sap.ui.getCore().requireDetailEdit[r].Note;e[i]["Werks"]=sap.ui.getCore().requireDetailEdit[r].Werks;e[i]["Ekgrp"]=sap.ui.getCore().requireDetailEdit[r].Ekgrp;e[i]["Knttp"]=sap.ui.getCore().requireDetailEdit[r].Knttp;e[i]["Asset"]=sap.ui.getCore().requireDetailEdit[r].Asset;e[i]["Hkont"]=sap.ui.getCore().requireDetailEdit[r].Hkont;e[i]["Kostl"]=sap.ui.getCore().requireDetailEdit[r].Kostl;e[i]["wbs"]=sap.ui.getCore().requireDetailEdit[r].wbs;e[i]["Lgort"]=sap.ui.getCore().requireDetailEdit[r].Lgort;sap.ui.getCore().edititem=t}})}else{sap.ui.getCore().edititem=t}}}else{sap.ui.getCore().edititem=t}},calculateTotal:function(e){var t=0,r;if(e.length>0){for(var i=0;i<e.length;i++){t=t+e[i].Price*e[i].Quantity;r=e[i].CurrencyCode}this.getView().byId("sum").setText(t+r)}else{this.getView().byId("sum").setText(t)}},onChange:function(e){var t=e.getSource().getParent().getBindingContext("PrList").getObject();t.Dmbtr=t.Quantity*t.Price;var r=this.getView().getModel("PrList").getData();this.calculateTotal(r);sap.ui.getCore().cartmodel=this.getView().getModel("PrList")},onAfterRendering:function(){},onDelete:function(e){var t=this;var r=this.getView().byId("ObjectId").getText();this.getModel().callFunction("/DeleteCartData",{method:"POST",urlParameters:{ObjectId:r},success:function(e,r){a.show("删除成功");sap.ui.getCore().cartmodel.setData([]);t.getModel().refresh()},error:function(e){a.show("删除失败")}})},onMultipleDelete:function(e){var t=this;var r=this.getView().byId("ObjectId").getText();var i=this.byId("PrTable").getSelectedIndices();if(i.length===0){a.show("请至少选择一行进行删除");return}if(r!==undefined&&r!==""){this.getModel().callFunction("/DeleteCartItemData",{method:"POST",urlParameters:{ObjectId:r,Posnr:i},success:function(e,r){var o=sap.ui.getCore().cartmodel.getData();if(i.length===o.length){o.splice(0,o.length)}else{for(var s=0;s<i.length;s++){o.splice(i[s],1)}}u.setData(o);sap.ui.getCore().cartmodel=this.getView().getModel("PrList");t.getModel().refresh();a.show("行项目删除成功")},error:function(e){a.show("行项目删除失败")}})}else{a.show("请先保存数据")}},onSubmit:function(e){var t=this.getView().byId("ObjectId").getText();var r=this;if(t!==undefined){this.getModel().callFunction("/SubmitCartData",{method:"POST",urlParameters:{ObjectId:t},success:function(e,t){a.show("提交OA成功");r.getModel().refresh()},error:function(e){var t=JSON.parse(e.responseText);var r=t.error.message.value;a.show("提交失败,消息:"&&r)}})}else{a.show("请先保存")}},onContinue:function(e){this.getOwnerComponent().getRouter().navTo("catalogSearchDetails",{})},onBatchUpdate:function(e){var t=this.byId("PrTable").getSelectedIndices();if(t.length===0){a.show("请至少选择一行进行批量修改");return}else{this.getOwnerComponent().getRouter().navTo("BatchEdit",{})}},onItemPress:function(e){var t=e.getSource().getBindingContext("PrList").getObject();d.push(t);this.onItemDisData(d,t);this.getOwnerComponent().getRouter().navTo("requireDetail",{ProductId:t.ProductId})},onSave:function(e){var t=new n;var r=this.byId("ObjectPageLayout");if(t.validate(r)){var i=this.getView().getModel("RequireHead").getData();var o=[];if(this.getView().getModel("PrList")!==undefined){var s=sap.ui.getCore().cartmodel.getData();var u=this.getView().getModel("PrList").getData();var g=sap.ui.getCore().requireDetailEdit;if(s===undefined&&g===undefined){a.show("请先编辑明细数据");return}else if(g!==undefined){for(var d=0;d<u.length;d++){var l;var c=g[d].Knttp;if(c==="A"){l=g[d].Asset}else if(c==="K"){l=g[d].Kostl}else if(c==="P"){l=g[d].wbs}var h={Posnr:u[d].Posnr.toString(),ProductId:u[d].Matnr,Description:u[d].Maktx,Menge:u[d].Quantity.toString(),Meins:u[d].Meins,Netpr:u[d].Price,Lifnr:u[d].Lifnr,LifnrNam:u[d].NameGp,Value:u[d].Dmbtr.toString(),Waers:u[d].CurrencyCode,CategoryId:u[d].CategoryId,CategoryTxt:u[d].Category,Matkl:u[d].Matkl,Hkont:g[0].Hkont,DelivDate:g[0].DelivDate,Ekgrp:g[0].Ekgrp,Werks:g[0].Werks,Note:g[0].Note,Knttp:g[0].Knttp,Lgort:g[0].Lgort,KnValue:l,Mwskz:u[d].Mwskz,Peinh:u[d].Peinh.toString(),Ekorg:i.Ekorg,Bukrs:i.Bukrs};o.push(h)}}else if(s!==undefined){for(var d=0;d<s.length;d++){if(s[d].DelivDate===undefined||s[d].Werks===undefined){a.show("请先输入必输项");return}var l;var c=s[d].Knttp;if(c==="A"){l=s[d].Asset}else if(c==="K"){if(s[d].Kostl===undefined){a.show("请先输入必输项");return}l=s[d].Kostl}var h={Posnr:s[d].Posnr.toString(),ProductId:s[d].Matnr,Description:s[d].Maktx,Menge:s[d].Quantity.toString(),Meins:s[d].Meins,Netpr:s[d].Price,Lifnr:s[d].Lifnr,LifnrNam:s[d].NameGp,Value:s[d].Dmbtr.toString(),Waers:s[d].CurrencyCode,CategoryId:s[d].CategoryId,CategoryTxt:s[d].Category,Matkl:s[d].Matkl,Hkont:s[d].Hkont,DelivDate:s[d].DelivDate,Ekgrp:s[d].Ekgrp,Werks:s[d].Werks,Note:s[d].Note,Knttp:s[d].Knttp,Lgort:s[d].Lgort,KnValue:l,Mwskz:s[d].Mwskz,Peinh:s[d].Peinh.toString(),Ekorg:i.Ekorg,Bukrs:i.Bukrs};o.push(h)}}var f={ObjectId:i.ObjectId,Description:i.Description,Ernam:i.Ernam,Bukrs:i.Bukrs,Ekorg:i.Ekorg,Remark:i.Remark,Stat:"10",GrAddr:i.GrAddr,Bsart:i.Bsart,CartItemSet:o};var v=this;var p=this.getView().byId("ObjectId").getText();if(p===""){var D="创建成功"}else{var D="更新成功"}this.getModel().create("/CartSet",f,{async:false,success:function(e,t){v.getView().byId("ObjectId").setText(e.ObjectId);v.getView().byId("Ernam").setText(e.Ernam);a.show("PR号"+e.ObjectId+D)},error:function(e){var t=JSON.parse(e.responseText);var r=t.error.message.value;a.show("PR号创建失败,消息:"&&r)}})}}},onRequestNavBack:function(){var e=o.getInstance().getPreviousHash();var r=new t([]);var e=o.getInstance().getPreviousHash();var i=sap.ui.getCore().requireDetailEdit;var a=this;var s=this.getView().getModel("RequireHead").getData();if(s.ObjectId!==undefined){sap.ui.getCore().cartmodel.setData([]);if(i!==undefined){for(var n=0;n<i.length;n++){i[n].Werks="";i[n].Lgort="";i[n].Kostl="";i[n].Hoknt="";i[n].Note="";sap.ui.getCore().requireDetailEdit=i}}var u={Bukrs:s.Bukrs,Ekorg:s.Ekorg};r.setData(u);this.getView().setModel(r,"RequireHead");this.getView().setModel(r,"PrList");this.getView().setModel(r,"BatchEdit")}if(e!==undefined){history.go(-1)}else{var g=true;this.getRouter().navTo("Home",{},g)}}})});
//# sourceMappingURL=Myhome.controller.js.map